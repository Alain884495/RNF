{% extends 'service/commerce/amc/accueilDemandeamc.html' %}
{% load static %}

{% block title %}Créer une demande AMC{% endblock title %}

{% block content %}
<div class="container mt-1 mb-3">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="card-title text-center mb-0">Créer une nouvelle demande AMC</h3>
        </div>
        <div class="card-body">
            <form action="{% url 'service:creerDemandeamc' %}" method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- En-tête du formulaire -->
                <div class="row mb-1">
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label class="form-label fw-bold">Demande N°</label>
                            <input type="text" class="form-control bg-light" value="{{ numeroCertificat }}{{ sigle.sigle_amc }}" id="demandeN" name="demandeN" readonly>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="form-group">
                            <label for="reference" class="form-label fw-bold">Référence</label>
                            <input type="text" class="form-control" id="reference" name="reference" required>
                            <div class="invalid-feedback">
                                Veuillez saisir une référence.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Informations Opérateur -->
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">Informations Opérateur</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="raisonSociale" class="form-label">Raison Sociale</label>
                                    <input onclick="openPopup()" type="text" class="form-control" id="raisonSociale" name="raisonSociale" required autocomplete="off" autocorrect="off" spellcheck="false">
                                    <div class="invalid-feedback">
                                        Ce champ est obligatoire.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="nif" class="form-label">NIF</label>
                                    <input type="text" class="form-control" id="nif" name="nif" required>
                                    <div class="invalid-feedback">
                                        Veuillez saisir le NIF.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="adresse" class="form-label">Adresse Professionnelle</label>
                                    <textarea class="form-control" id="adresse" rows="2" name="adresse" required></textarea>
                                    <div class="invalid-feedback">
                                        Veuillez saisir l'adresse professionnelle.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informations Marchandise -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h5 class="card-title mb-0">Informations Marchandise</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="produit" class="form-label">Produits</label>
                                    <input type="text" class="form-control" id="produit" name="produit" required>
                                    <div class="invalid-feedback">
                                        Veuillez spécifier le produit.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="pays" class="form-label">Pays d'origine</label>
                                    <input type="text" class="form-control" id="pays" name="pays" required>
                                    <div class="invalid-feedback">
                                        Veuillez indiquer le pays d'origine.
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label for="quantite" class="form-label">Quantité</label>
                                        <input type="number" class="form-control" id="quantite" name="quantite" required>
                                    </div>
                                    <div class="col-6">
                                        <label for="unite" class="form-label">Unité</label>
                                        <select class="form-select" id="unite" name="unite" required>
                                            <option value="">Sélectionner...</option>
                                            <option value="kg">kg</option>
                                            <option value="g">g</option>
                                            <option value="L">L</option>
                                            <option value="m">m</option>
                                            <option value="unite">unité</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <a href="{% url 'service:accueilDemandeamc' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Retour
                    </a>
                    <div class="mx-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Enregistrer
                        </button>
                    </div>
                    <div class="d-none d-md-block" style="width: 80px">
                        <!-- Espace vide pour équilibrer le flex -->
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Messages d'alerte -->
{% if messages %}
    {% for message in messages %}
        {% if message.tags == 'error' %}
            <div class="position-fixed top-50 start-50 translate-middle" style="z-index: 1050; min-width: 400px;">
            <div class="alert alert-danger alert-dismissible fade show shadow-lg" role="alert">
        {% elif message.tags == 'success' %}
            <div class="position-fixed top-50 start-50 translate-middle" style="z-index: 1050; min-width: 400px;">
            <div class="alert alert-success alert-dismissible fade show shadow-lg" role="alert">
        {% else %}
            <div class="position-fixed top-50 start-50 translate-middle" style="z-index: 1050; min-width: 400px;">
            <div class="alert alert-info alert-dismissible fade show shadow-lg" role="alert">
        {% endif %}
                <div class="d-flex align-items-center">
                    {% if message.tags == 'success' %}
                        <i class="fas fa-check-circle me-3 fs-4"></i>
                    {% else %}
                        <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                    {% endif %}
                    <div class="flex-grow-1">
                        {{ message }}
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fermer"></button>
                </div>
            </div>
        </div>
    {% endfor %}

    <!-- Script pour gérer les champs vides et fermer les alertes -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Fermeture automatique des alertes après 5 secondes
            var alertList = document.querySelectorAll('.alert');
            alertList.forEach(function(alert) {
                var bsAlert = new bootstrap.Alert(alert);
                setTimeout(function() {
                    bsAlert.close();
                }, 5000);
            });

            // Mise en évidence des champs vides
            {% if champs_vides %}
                // Ajouter la classe is-invalid aux champs vides
                {% for champ in champs_vides %}
                    var champInput = document.getElementById('{{ champ }}');
                    if (champInput) {
                        champInput.classList.add('is-invalid');
                        // Ajouter un message d'erreur personnalisé
                        var div = document.createElement('div');
                        div.className = 'invalid-feedback';
                        div.textContent = 'Ce champ est obligatoire';
                        champInput.parentNode.insertBefore(div, champInput.nextSibling);
                        
                        // Focus sur le premier champ vide
                        if ({{ forloop.first|yesno:'true,false' }}) {
                            champInput.focus();
                        }
                    }
                {% endfor %}
                
                // Faire défiler jusqu'au premier champ vide
                var firstInvalid = document.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            {% endif %}

            // Supprimer le style d'erreur quand l'utilisateur commence à saisir
            document.querySelectorAll('input, textarea').forEach(function(input) {
                input.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        this.classList.remove('is-invalid');
                        var feedback = this.nextElementSibling;
                        if (feedback && feedback.classList.contains('invalid-feedback')) {
                            feedback.remove();
                        }
                    }
                });
            });
        });
    </script>
{% endif %}


<!-- Script pour la validation du formulaire -->
<script>
// Exemple de validation JavaScript personnalisée
(function () {
  'use strict'
  var forms = document.querySelectorAll('.needs-validation')
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
})()
</script>
{% endblock content %}



{% block popup %}
    <div>
        <h2 class="text-center">Sélectionner Opérateur</h2>

        <div class="mb-3">
            <label for="raison" class="form-label fw-semibold">Raison sociale</label>
            <div class="input-group" style="max-width: 400px;">
                <span class="input-group-text bg-white border-end-0">
                    <label for="raison" class="form-label"><i class="bi bi-search text-muted"></i></label>
                </span>
                <input type="text" 
                       id="raison" 
                       class="form-control border-start-0" 
                       placeholder="Rechercher une entreprise..."
                       onkeyup="filterTable()">
            </div>
        </div>

        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped mt-2 mb-0">
                <thead class="sticky-top">
                    <tr class="table-primary text-center">
                        <th>N°</th>
                        <th>Raison Sociale</th>
                        <th>NIF</th>
                        <th>Adresse</th>
                    </tr>
                </thead>
                <tbody class="table-group-divider">
                    {% for operateur in operateurs %}
                    <tr class="text-center" style="cursor: pointer;" 
                        onclick="selectOperator({{ forloop.counter }}, '{{ operateur.raison_sociale }}', '{{ operateur.nif }}', '{{ operateur.adresse_pro }}')">
                        <td>{{ forloop.counter }}</td>
                        <td class="text-start">{{ operateur.raison_sociale }}</td>
                        <td>{{ operateur.nif }}</td>
                        <td class="text-start">{{ operateur.adresse_pro }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <button type="button" class="btn btn-secondary" onclick="closePopup()">
                <i class="bi bi-arrow-left"></i> Retour
            </button>
        </div>
    </div>
{% endblock popup %}